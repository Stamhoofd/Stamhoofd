<template>
    <SaveView save-text="Bevestigen" mainClass="flex" :save-badge="cartLength" :disabled="cartLength === 0" title="Inschrijvingen wijzigen" :loading="saving" @save="goToCheckout">
        <p v-if="!checkout.isAdminFromSameOrganization && checkout.singleOrganization" class="style-title-prefix">
            {{ checkout.singleOrganization.name }}
        </p>
        <h1 v-if="group">
            Inschrijvingen voor {{ group.settings.name }} wijzigen
        </h1>
        <h1 v-else>
            Winkelmandje
        </h1>

        <p v-if="checkout.totalPrice && checkout.isAdminFromSameOrganization" class="info-box">
            De kosten zullen aan het openstaande bedrag van elk lid worden toegevoegd. Leden kunnen dit betalen via het ledenportaal.
        </p>

        <STErrorsDefault :error-box="errors.errorBox" />
        
        <STList>
            <DeleteRegistrationRow v-for="registration in checkout.cart.deleteRegistrations" :key="registration.id" class="right-stack" :registration="registration" :checkout="checkout" />
            <RegisterItemRow v-for="item in checkout.cart.items" :key="item.id" class="right-stack" :item="item" :show-group="false" />
            <BalanceItemCartItemRow v-for="item in checkout.cart.balanceItems" :key="item.id" class="right-stack" :item="item" :checkout="checkout" />
        </STList>
        
        <p v-if="checkout.cart.isEmpty" class="info-box">
            Voeg de leden toe die je wilt inschrijven
        </p>

        <p v-if="group" class="style-button-bar">
            <button type="button" class="button text" @click="searchMembers">
                <span class="icon search" />
                <span>Zoek bestaande leden</span>
            </button>

            <button type="button" class="button text" @click="addMember">
                <span class="icon add" />
                <span>Splinternieuw lid</span>
            </button>
        </p>

        <PriceBreakdownBox v-if="!checkout.isAdminFromSameOrganization" :price-breakdown="checkout.priceBreakown" />
    </SaveView>
</template>

<script setup lang="ts">
import { ComponentWithProperties, NavigationController, usePresent } from '@simonbackx/vue-app-navigation';
import { CenteredMessage, ErrorBox, PriceBreakdownBox, STErrorsDefault, useErrors } from '@stamhoofd/components';
import { Group, Organization, PlatformFamily, PlatformMember, RegisterCheckout } from '@stamhoofd/structures';
import { computed, onMounted, ref } from 'vue';
import { startCheckout, useAddMember, useCheckoutDefaultItem, useChooseGroupForMember } from '.';
import { useContext, useOrganization, usePlatform } from '../hooks';
import { NavigationActions, useNavigationActions } from '../types/NavigationActions';
import DeleteRegistrationRow from './components/group/DeleteRegistrationRow.vue';
import RegisterItemRow from './components/group/RegisterItemRow.vue';
import SearchOrganizationMembersForGroupView from './SearchOrganizationMembersForGroupView.vue';
import { useTranslate } from '@stamhoofd/frontend-i18n';
import BalanceItemCartItemRow from './components/group/BalanceItemCartItemRow.vue';

const props = defineProps<{
    checkout: RegisterCheckout, // we should auto assign this checkout to all search results and newly created members
    group?: Group // If you want to add new members to the cart
    groupOrganization: Organization,
    members?: PlatformMember[] // Optional: used to update the members after the checkout
}>();

onMounted(() => {
    // Initially show errors as soon as it is possible
    try {
        props.checkout.validate({})
    } catch (e) {
        errors.errorBox = new ErrorBox(e)
    }
})

const context = useContext();
const contextOrganization = useOrganization()
const platform = usePlatform();
const present = usePresent()
const navigate = useNavigationActions();
const errors = useErrors();
const saving = ref(false)
const cartLength = computed(() => props.checkout.cart.count)
const $addMember = useAddMember()
const checkoutDefaultItem = useCheckoutDefaultItem()
const chooseGroupForMember = useChooseGroupForMember()
const $t = useTranslate();

async function addMember() {
    const family = new PlatformFamily({
        contextOrganization: contextOrganization.value,
        platform: platform.value
    })
    family.checkout = props.checkout

    await $addMember(family, {
        displayOptions: {action: 'present', modalDisplayStyle: 'popup'},
        async finishHandler(member, navigate) {
            if (!props.group) {
                await chooseGroupForMember({
                    member,
                    displayOptions: {action: 'show', replace: 100, force: true},
                    customNavigate: navigate,
                    startCheckoutFlow: false
                })
                return
            }

            await checkoutDefaultItem({
                member,
                group: props.group,
                groupOrganization: props.groupOrganization,
                startCheckoutFlow: false,
                displayOptions: {action: 'show', replace: 100, force: true},
                customNavigate: navigate
            })
        },
    });
}

async function searchMembers() {
    await present({
        components: [
            new ComponentWithProperties(NavigationController, {
                root: new ComponentWithProperties(SearchOrganizationMembersForGroupView, {
                    ...props,
                    saveHandler: async (navigate: NavigationActions) => {
                        await navigate.dismiss({force: true})
                    }
                })
            })
        ],
        modalDisplayStyle: "popup"
    })
}

async function goToCheckout() {
    if (saving.value) {
        return
    }

    saving.value = true
    try {
        await startCheckout({
            admin: true,
            checkout: props.checkout,
            context: context.value,
            members: props.members,
            displayOptions: {action: 'show'}
        }, navigate)
    } catch (e) {
        errors.errorBox = new ErrorBox(e)
    } finally {
        saving.value = false
    }
}

const shouldNavigateAway = async () => {
    if (props.checkout.cart.isEmpty) {
        return true;
    }
    return await CenteredMessage.confirm($t('Ben je zeker dat je wilt sluiten zonder op te slaan?'), $t('Niet opslaan'))
}

defineExpose({
    shouldNavigateAway
})


</script>
